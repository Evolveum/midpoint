<!--
  ~ Copyright (C) 2010-2022 Evolveum and contributors
  ~
  ~ Licensed under the EUPL-1.2 or later.
  -->

<functionLibrary oid="44e7f86c-604e-4127-8b0f-33bd7310ecb8"
                 xmlns='http://midpoint.evolveum.com/xml/ns/public/common/common-3'
                 xmlns:c='http://midpoint.evolveum.com/xml/ns/public/common/common-3'
                 xmlns:xsd='http://www.w3.org/2001/XMLSchema'>
    <name>mylib</name>
    <function>
        <name>createAssignment</name>
        <parameter>
            <name>subtype</name>
            <type>xsd:string</type>
        </parameter>
        <parameter>
            <name>sourceId</name>
            <type>xsd:string</type>
        </parameter>
        <parameter>
            <name>targetName</name>
            <type>xsd:string</type>
        </parameter>
        <returnType>c:AssignmentType</returnType>
        <returnMultiplicity>single</returnMultiplicity>
        <script>
            <code>
                import com.evolveum.midpoint.xml.ns._public.common.common_3.*


                import com.evolveum.midpoint.schema.util.*
                import com.evolveum.midpoint.prism.path.*

                def assignment = new AssignmentType()
                        .subtype(subtype)
                        .subtype(subtype + '-' + sourceId)

                // This is not strictly necessary (just an example of storing something to assignment extension)
                setExtensionValue(assignment, 'sourceId', sourceId)

                if (targetName != null) {
                    target = midpoint.getOrgByName(targetName)
                    if (target != null) {
                        assignment.targetRef(target.oid, OrgType.COMPLEX_TYPE)
                    }
                    // TODO else undefined?
                }

                assignment

                def setExtensionValue(containerable, name, value) {
                    if (value != null) {
                        ObjectTypeUtil.setExtensionPropertyRealValues(
                                midpoint.prismContext, containerable.asPrismContainerValue(), new ItemName(name),
                                value)
                    } else {
                        ObjectTypeUtil.setExtensionPropertyRealValues(
                                midpoint.prismContext, containerable.asPrismContainerValue(), new ItemName(name))
                    }
                }
            </code>
        </script>
    </function>
</functionLibrary>
