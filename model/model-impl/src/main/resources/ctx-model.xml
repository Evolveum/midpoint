<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ Copyright (c) 2010-2013 Evolveum
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:jaxws="http://cxf.apache.org/jaxws"
       xmlns:ssec="http://cxf.apache.org/spring-security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
     http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
     http://www.springframework.org/schema/context
     http://www.springframework.org/schema/context/spring-context-3.0.xsd
     http://cxf.apache.org/jaxws
     http://cxf.apache.org/schemas/jaxws.xsd
     http://cxf.apache.org/spring-security
     http://cxf-spring-security.googlecode.com/svn/trunk/cxf-spring-security/src/main/resources/schemas/spring-security.xsd"
       default-lazy-init="false"
       default-autowire="byName">

    <!-- enabling annotation driven configuration -->
    <context:annotation-config/>
    <context:component-scan base-package="com.evolveum.midpoint.model"/>
    <context:spring-configured/>
    
    <bean id="basicFunctionObject" class="com.evolveum.midpoint.common.expression.functions.BasicExpressionFunctions"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="basicFunctionObjectXml" class="com.evolveum.midpoint.common.expression.functions.BasicExpressionFunctionsXPath"
          scope="singleton">
          <constructor-arg type="com.evolveum.midpoint.common.expression.functions.BasicExpressionFunctions" ref="basicFunctionObject"/>
    </bean>
    
    <bean id="basicFunctionLibrary" class="com.evolveum.midpoint.common.expression.functions.FunctionLibrary"
          scope="singleton">
        <property name="variableName" value="basic"/>
        <property name="namespace" value="http://midpoint.evolveum.com/xml/ns/public/function/basic-2"/>
        <property name="genericFunctions">
            <ref bean="basicFunctionObject"/>
        </property>
        <property name="xmlFunctions">
            <ref bean="basicFunctionObjectXml"/>
        </property>
    </bean>

    <bean id="logFunctionObject" class="com.evolveum.midpoint.common.expression.functions.LogExpressionFunctions"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="logFunctionLibrary" class="com.evolveum.midpoint.common.expression.functions.FunctionLibrary"
          scope="singleton">
        <property name="variableName" value="log"/>
        <property name="namespace" value="http://midpoint.evolveum.com/xml/ns/public/function/log-2"/>
        <property name="genericFunctions">
            <ref bean="logFunctionObject"/>
        </property>
    </bean>
    
    <bean id="midpointFunctionLibrary" class="com.evolveum.midpoint.common.expression.functions.FunctionLibrary"
          scope="singleton">
        <property name="variableName" value="midpoint"/>
        <property name="namespace" value="http://midpoint.evolveum.com/xml/ns/public/function/midpoint-2"/>
        <property name="genericFunctions">
            <ref bean="midpointFunctionsImpl"/>
        </property>
    </bean>

    <bean id="xpathScriptEvaluator" class="com.evolveum.midpoint.common.expression.script.xpath.XPathScriptEvaluator"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="javascriptScriptEvaluator" class="com.evolveum.midpoint.common.expression.script.jsr223.Jsr223ScriptEvaluator"
          scope="singleton">
          <constructor-arg name="engineName" value="JavaScript"/>
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>

    <bean id="groovyScriptEvaluator" class="com.evolveum.midpoint.common.expression.script.jsr223.Jsr223ScriptEvaluator"
          scope="singleton">
          <constructor-arg name="engineName" value="groovy"/>
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="scriptExpressionFactory" class="com.evolveum.midpoint.common.expression.script.ScriptExpressionFactory"
          scope="singleton">
          <constructor-arg ref="modelObjectResolver"/>
          <constructor-arg name="prismContext" ref="prismContext"/>
          <constructor-arg>
        	<list>
        		<ref bean="basicFunctionLibrary"/>
        		<ref bean="logFunctionLibrary"/>
        		<ref bean="midpointFunctionLibrary"/>
        	</list>
        </constructor-arg>
          <constructor-arg>
        	<list>
        		<ref bean="xpathScriptEvaluator"/>
        		<ref bean="javascriptScriptEvaluator"/>
        		<ref bean="groovyScriptEvaluator"/>
        	</list>
        </constructor-arg>
    </bean>

    <bean id="scriptExpressionEvaluatorFactory" class="com.evolveum.midpoint.common.expression.script.ScriptExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg ref="scriptExpressionFactory"/>
    </bean>
    
    <bean id="generateExpressionEvaluatorFactory" class="com.evolveum.midpoint.common.expression.evaluator.GenerateExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg ref="protector"/>
          <constructor-arg ref="modelObjectResolver"/>
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="pathExpressionEvaluatorFactory" class="com.evolveum.midpoint.common.expression.evaluator.PathExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
          <constructor-arg ref="modelObjectResolver"/>
    </bean>
    
    <bean id="literalExpressionEvaluatorFactory" class="com.evolveum.midpoint.common.expression.evaluator.LiteralExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="asisExpressionEvaluatorFactory" class="com.evolveum.midpoint.common.expression.evaluator.AsIsExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>

    <bean id="expressionFactory" class="com.evolveum.midpoint.common.expression.ExpressionFactory" 
    		scope="singleton">
        <constructor-arg>
        	<ref bean="modelObjectResolver"/>
        </constructor-arg>
        <constructor-arg>
        	<ref bean="prismContext"/>
        </constructor-arg>
        <constructor-arg>
        	<list>
        		<ref bean="scriptExpressionEvaluatorFactory"/>
        		<ref bean="generateExpressionEvaluatorFactory"/>
        		<ref bean="pathExpressionEvaluatorFactory"/>
        		<ref bean="literalExpressionEvaluatorFactory"/>
        		<ref bean="asisExpressionEvaluatorFactory"/>
        	</list>
        </constructor-arg>
        <property name="defaultEvaluatorFactory">
            <ref bean="asisExpressionEvaluatorFactory"/>
        </property>
    </bean>

    <bean id="mappingFactory" class="com.evolveum.midpoint.common.mapping.MappingFactory"
          scope="singleton">
        <property name="expressionFactory">
            <ref bean="expressionFactory"/>
        </property>
        <property name="objectResolver">
            <ref bean="modelObjectResolver"/>
        </property>
        <property name="protector">
            <ref bean="protector"/>
        </property>
        <property name="prismContext">
            <ref bean="prismContext"/>
        </property>
        <property name="filterManager">
            <ref bean="filterManager"/>
        </property>
    </bean>

    <bean id="actionManager" class="com.evolveum.midpoint.model.sync.ActionManagerImpl">
        <property name="actionMapping">
            <map>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#addUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.AddUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#modifyUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.ModifyUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#disableUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.DisableUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#enableUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.EnableUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#linkAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.LinkAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#unlinkAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.UnlinkAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#deleteAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.DeleteAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#disableAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.DisableAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#addAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.AddAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#deleteUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.DeleteUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#modifyPassword">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.ModifyPasswordAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-2#synchronize">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.SynchronizeAction</value>
                </entry>
            </map>
        </property>
        <property name="model">
            <ref bean="modelController"/>
        </property>
        <property name="clockwork">
            <ref bean="clockwork"/>
        </property>
        <property name="changeExecutor">
            <ref bean="changeExecutor"/>
        </property>
        <property name="prismContext">
            <ref bean="prismContext"/>
        </property>
        <property name="auditService">
            <ref bean="auditService"/>
        </property>
        <property name="provisioningService">
            <ref bean="provisioningService"/>
        </property>

    </bean>

    <bean id="filterManager" class="com.evolveum.midpoint.common.filter.FilterManagerImpl">
        <property name="filterMapping">
            <map>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/common/value-filter-1.xsd#emptyFilter">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.filter.EmptyFilter</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/common/value-filter-1.xsd#patternFilter">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.filter.PatternFilter</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/common/value-filter-1.xsd#diacriticsFilter">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.filter.DiacriticsFilter</value>
                </entry>
            </map>
        </property>
    </bean>

    <import resource="classpath:META-INF/cxf/cxf.xml"/>
    <import resource="classpath:META-INF/cxf/cxf-servlet.xml"/>

	<bean id="authorizationEvaluator" class="com.evolveum.midpoint.common.security.AuthorizationEvaluator">
    </bean>
    
    <jaxws:endpoint id="modelWS"
                    address="/model-1">
        <jaxws:implementor>
            <bean parent="modelWebService"/>
        </jaxws:implementor>
        <jaxws:inInterceptors>
            <ref bean="authenticationInterceptor"/>
            <ref bean="springAuthenticationInjector"/>
            <ref bean="springAuthenticationJanitor"/>

            <!--
                        <ref bean="authorizationInterceptor"/>
            -->
        </jaxws:inInterceptors>
        <jaxws:outInterceptors>

        </jaxws:outInterceptors>
    </jaxws:endpoint>

    <bean id="authenticationInterceptor" class="org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor">
        <constructor-arg>
            <map>
                <entry key="action" value="UsernameToken"/>
                <entry key="passwordType" value="PasswordDigest"/>
                <entry key="passwordCallbackRef">
                    <ref bean="passwordCallback"/>
                </entry>
            </map>
        </constructor-arg>
    </bean>

    <bean id="springAuthenticationInjector" class="com.evolveum.midpoint.model.security.SpringAuthenticationInjectorInterceptor">
        <constructor-arg name="userDetailsService" ref="userDetailsService"/>
        <constructor-arg name="authorizationEvaluator" ref="authorizationEvaluator"/>
    </bean>

    <bean id="springAuthenticationJanitor" class="com.evolveum.midpoint.model.security.SpringAuthenticationJanitorInterceptor">
    </bean>


    <bean id="passwordCallback" class="com.evolveum.midpoint.model.security.PasswordCallback">
        <constructor-arg name="userDetailsService" ref="userDetailsService"/>
        <constructor-arg name="protector" ref="protector"/>
    </bean>

    <!--Example of authorization for WS-->
    <!--
        <bean id="authorizationInterceptor" class="org.apache.cxf.interceptor.security.SimpleAuthorizingInterceptor">
            <property name="methodRolesMap">
                <map>
                    <entry key="getObject" value="ROLE_USER ROLE_ADMIN"/>
                    <entry key="addObject" value="ROLE_ADMIN"/>
                </map>
            </property>
        </bean>
    -->

</beans>
