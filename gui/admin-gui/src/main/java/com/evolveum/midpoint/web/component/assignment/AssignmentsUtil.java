package com.evolveum.midpoint.web.component.assignment;

import java.util.Date;
import java.util.function.Function;

import javax.xml.datatype.XMLGregorianCalendar;

import org.apache.wicket.Component;
import org.apache.wicket.ajax.AjaxRequestTarget;
import org.apache.wicket.ajax.form.AjaxFormComponentUpdatingBehavior;
import org.apache.wicket.markup.html.WebMarkupContainer;
import org.apache.wicket.markup.html.form.FormComponent;
import org.apache.wicket.model.AbstractReadOnlyModel;
import org.apache.wicket.model.IModel;
import org.apache.wicket.model.Model;
import org.apache.wicket.util.visit.IVisit;
import org.apache.wicket.util.visit.IVisitor;

import com.evolveum.midpoint.gui.api.component.BasePanel;
import com.evolveum.midpoint.gui.api.page.PageBase;
import com.evolveum.midpoint.gui.api.util.WebComponentUtil;
import com.evolveum.midpoint.util.MiscUtil;
import com.evolveum.midpoint.util.logging.Trace;
import com.evolveum.midpoint.util.logging.TraceManager;
import com.evolveum.midpoint.web.component.prism.InputPanel;
import com.evolveum.midpoint.web.component.util.VisibleEnableBehaviour;
import com.evolveum.midpoint.web.page.admin.users.dto.UserDtoStatus;
import com.evolveum.midpoint.xml.ns._public.common.common_3.ActivationStatusType;
import com.evolveum.midpoint.xml.ns._public.common.common_3.ActivationType;
import com.evolveum.midpoint.xml.ns._public.common.common_3.AssignmentType;
import com.evolveum.midpoint.xml.ns._public.common.common_3.ConstructionType;
import com.evolveum.midpoint.xml.ns._public.common.common_3.ObjectReferenceType;
import com.evolveum.midpoint.xml.ns._public.common.common_3.OrgType;
import com.evolveum.midpoint.xml.ns._public.common.common_3.PolicyRuleType;
import com.evolveum.midpoint.xml.ns._public.common.common_3.TimeIntervalStatusType;

/**
 * Created by honchar.
 */
public class AssignmentsUtil {
    private static final long serialVersionUID = 1L;

    private static final Trace LOGGER = TraceManager.getTrace(AssignmentsUtil.class);

    public static IModel<String> createActivationTitleModel(IModel<AssignmentEditorDto> model, String defaultTitle, BasePanel basePanel) {
        return new AbstractReadOnlyModel<String>() {
            private static final long serialVersionUID = 1L;

            @Override
            public String getObject() {
                AssignmentEditorDto dto = model.getObject();
                ActivationType activation = dto.getActivation();
                if (activation == null) {
                    return defaultTitle;
                }

                ActivationStatusType status = activation.getAdministrativeStatus();
                String strEnabled = basePanel.createStringResource(status, "lower", "ActivationStatusType.null")
                        .getString();

                if (activation.getValidFrom() != null && activation.getValidTo() != null) {
                    return basePanel.getString("AssignmentEditorPanel.enabledFromTo", strEnabled,
                            MiscUtil.asDate(activation.getValidFrom()),
                            MiscUtil.asDate(activation.getValidTo()));
                } else if (activation.getValidFrom() != null) {
                    return basePanel.getString("AssignmentEditorPanel.enabledFrom", strEnabled,
                            MiscUtil.asDate(activation.getValidFrom()));
                } else if (activation.getValidTo() != null) {
                    return basePanel.getString("AssignmentEditorPanel.enabledTo", strEnabled,
                            MiscUtil.asDate(activation.getValidTo()));
                }

                return strEnabled;
            }
        };
    }

    public static IModel<String> createActivationTitleModelExperimental(IModel<AssignmentDto> model, BasePanel basePanel) {
    	return createActivationTitleModelExperimental(model.getObject(), s -> s.value(), basePanel);
    }

    public static IModel<String> createActivationTitleModelExperimental(AssignmentDto model, Function<ActivationStatusType, String> transformStatusLambda, BasePanel basePanel) {

//    	AssignmentDto assignmentDto = model.getObject();
    	ActivationType activation = model.getAssignment().getActivation();
    	if (activation == null) {
    		return basePanel.createStringResource("lower.ActivationStatusType.null");
    	}

		TimeIntervalStatusType timeIntervalStatus = activation.getValidityStatus();
		if (timeIntervalStatus != null) {
			return createTimeIntervalStatusMessage(timeIntervalStatus, activation, basePanel);
		}

		ActivationStatusType status = activation.getEffectiveStatus();
		String statusString = transformStatusLambda.apply(status);

                if (activation.getValidFrom() != null && activation.getValidTo() != null) {
                	basePanel.createStringResource("AssignmentEditorPanel.enabledFromTo", statusString, MiscUtil.asDate(activation.getValidFrom()),
                            MiscUtil.asDate(activation.getValidTo()));
                } else if (activation.getValidFrom() != null) {
                    return basePanel.createStringResource("AssignmentEditorPanel.enabledFrom", statusString,
                            MiscUtil.asDate(activation.getValidFrom()));
                } else if (activation.getValidTo() != null) {
                    return basePanel.createStringResource("AssignmentEditorPanel.enabledTo", statusString,
                            MiscUtil.asDate(activation.getValidTo()));
                }

                return basePanel.createStringResource(statusString);

    }
    
    public static IModel<String> createConsentActivationTitleModel(IModel<AssignmentDto> model, BasePanel basePanel) {
    	return createActivationTitleModelExperimental(model.getObject(), 
    			s -> { 
    				// TODO: localization
    				switch (s) {
    					case ENABLED:
    						return "Consent given";
    					case ARCHIVED:
    					case DISABLED:
    						return "Consent not given";
    				}
    				return "";
    			}, basePanel);
    }


    private static IModel<String> createTimeIntervalStatusMessage(TimeIntervalStatusType timeIntervalStatus, ActivationType activation, BasePanel basePanel) {
    	switch (timeIntervalStatus) {
			case AFTER:
				return basePanel.createStringResource("ActivationType.validity.after", activation.getValidTo());
			case BEFORE:
				return basePanel.createStringResource("ActivationType.validity.before", activation.getValidFrom());
			case IN:
				return basePanel.createStringResource(activation.getEffectiveStatus());

			default:
				return basePanel.createStringResource(activation.getEffectiveStatus());
		}
    }

    public static IModel<Date> createDateModel(final IModel<XMLGregorianCalendar> model) {
        return new Model<Date>() {

            @Override
            public Date getObject() {
                XMLGregorianCalendar calendar = model.getObject();
                if (calendar == null) {
                    return null;
                }
                return MiscUtil.asDate(calendar);
            }

            @Override
            public void setObject(Date object) {
                if (object == null) {
                    model.setObject(null);
                } else {
                    model.setObject(MiscUtil.asXMLGregorianCalendar(object));
                }
            }
        };
    }

    //    public static IModel<String> createAssignmentStatusClassModel(final IModel<AssignmentEditorDto> model) {
//        return new AbstractReadOnlyModel<String>() {
//            private static final long serialVersionUID = 1L;
//
//            @Override
//            public String getObject() {
//                AssignmentEditorDto dto = model.getObject();
//                return dto.getStatus().name().toLowerCase();
//            }
//        };
//    }

    public static IModel<String> createAssignmentStatusClassModel(final IModel<AssignmentDto> model) {
        return new AbstractReadOnlyModel<String>() {
            private static final long serialVersionUID = 1L;

            @Override
            public String getObject() {
                AssignmentDto dto = model.getObject();
                return dto.getStatus().name().toLowerCase();
            }
        };
    }

    public static IModel<String> createAssignmentStatusClassModel(final UserDtoStatus model) {
        return new AbstractReadOnlyModel<String>() {
            private static final long serialVersionUID = 1L;

            @Override
            public String getObject() {
                return model.name().toLowerCase();
            }
        };
    }

    public static VisibleEnableBehaviour getEnableBehavior(IModel<AssignmentEditorDto> dtoModel){
        return new VisibleEnableBehaviour(){
            private static final long serialVersionUID = 1L;

            @Override
            public boolean isEnabled(){
                return dtoModel.getObject().isEditable();
            }
        };
    }

    public static IModel<String> createAssignmentIconTitleModel(BasePanel panel, AssignmentEditorDtoType type){
        return new AbstractReadOnlyModel<String>() {
            private static final long serialVersionUID = 1L;

            @Override
            public String getObject() {
                if (type == null) {
                    return "";
                }

                switch (type) {
                    case CONSTRUCTION:
                        return panel.getString("MyAssignmentsPanel.type.accountConstruction");
                    case ORG_UNIT:
                        return panel.getString("MyAssignmentsPanel.type.orgUnit");
                    case ROLE:
                        return panel.getString("MyAssignmentsPanel.type.role");
                    case SERVICE:
                        return panel.getString("MyAssignmentsPanel.type.service");
                    case USER:
                        return panel.getString("MyAssignmentsPanel.type.user");
                    case POLICY_RULE:
                        return panel.getString("MyAssignmentsPanel.type.policyRule");
                    default:
                        return panel.getString("MyAssignmentsPanel.type.error");
                }
            }
        };
    }

    public static String getName(AssignmentType assignment, PageBase pageBase) {
		if (assignment == null) {
			return null;
		}

		if (assignment.getPolicyRule() != null){
			PolicyRuleType policyRuleContainer = assignment.getPolicyRule();
			return policyRuleContainer.getName();

		}
		StringBuilder sb = new StringBuilder();

		if (assignment.getConstruction() != null) {
			// account assignment through account construction
			ConstructionType construction = assignment.getConstruction();
			if (construction.getResource() != null) {
				sb.append(WebComponentUtil.getName(construction.getResource()));
			} else if (construction.getResourceRef() != null) {
				sb.append(WebComponentUtil.getName(construction.getResourceRef()));
			}
			return sb.toString();
		}

		if (assignment.getTarget() != null) {
			sb.append(WebComponentUtil.getEffectiveName(assignment.getTarget(), OrgType.F_DISPLAY_NAME));
		} else if (assignment.getTargetRef() != null) {
			sb.append(WebComponentUtil.getEffectiveName(assignment.getTargetRef(), OrgType.F_DISPLAY_NAME, pageBase, "loadTargetName"));
		}
		appendTenantAndOrgName(assignment, sb, pageBase);

		appendRelation(assignment, sb);

		return sb.toString();
	}

    private static void appendTenantAndOrgName(AssignmentType assignmentType, StringBuilder sb, PageBase pageBase) {
    	ObjectReferenceType tenantRef = assignmentType.getTenantRef();
		if (tenantRef != null) {
			WebComponentUtil.getEffectiveName(tenantRef, OrgType.F_DISPLAY_NAME, pageBase, "loadTargetName");
		}

		ObjectReferenceType orgRef = assignmentType.getOrgRef();
		if (orgRef != null) {
			WebComponentUtil.getEffectiveName(orgRef, OrgType.F_DISPLAY_NAME, pageBase, "loadTargetName");
		}

	}

    private static void appendRelation(AssignmentType assignment, StringBuilder sb) {
    	if (assignment.getTargetRef() == null) {
    		return;
    	}
    	sb.append(" - "  + RelationTypes.getRelationType(assignment.getTargetRef().getRelation()).getHeaderLabel());

    }

    public static AssignmentEditorDtoType getType(AssignmentType assignment) {
		if (assignment.getTarget() != null) {
			// object assignment
			return AssignmentEditorDtoType.getType(assignment.getTarget().getClass());
		} else if (assignment.getTargetRef() != null) {
			return AssignmentEditorDtoType.getType(assignment.getTargetRef().getType());
		}
		if (assignment.getPolicyRule() != null){
			return AssignmentEditorDtoType.POLICY_RULE;
		}

		if (assignment.getPersonaConstruction() != null) {
			return AssignmentEditorDtoType.PERSONA_CONSTRUCTION;
		}
		// account assignment through account construction
		return AssignmentEditorDtoType.CONSTRUCTION;

	}


}
